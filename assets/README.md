# Опыт проведения нагрузочного тестирования "Отказ в обслуживании"
Пост о том, как мы проводили нагрузочное тестирование(Далее НТ) "Отказ в обслуживании" (DDoS-атака).

Приветствую, меня зовут Фёдор, ведущий инженер по нагрузочному тестированию. На 2024 год количество кибератак на электронную коммерцию, финансовые и образовательные технологии выросли в 2 раза, коллеги из направления защиты ИТ-инфраструктуры пришли с просьбой провести НТ на устойчивость к атакам на отказ в обслуживании информационных ресурсов. Ранее не приходилось тестировать сеть, но мы решили вооружить и Вас, чтобы знали с чем имеете дело. 

#### Содержание:
* [Цели и задачи](#Цели_и_задачи)
* [Тестовые сценарии](#Тестовые_сценарии)
* [Мониторинг](#Мониторинг)
* [Автоматизация](#Автоматизация)

### Цели и задачи
Основной целью НТ "Отказ в обслуживании" являлось проведение [тестов](https://school.kontur.ru/publications/2670) надежности, отказоустойчивости, определению максимальной производительности и выявлением "Узких мест", но с добавлением следующих типов DDoS-атак: 
+ Flood-атаки сетевого и транспортного уровней TCP/IP (TCP/UDP/ICMP)
+ Flood-атаки прикладного уровня TCP/IP (SMTP/HTTP(s)/DNS/NTP) 
+ Атаки на серверные приложения (Slowloris/SSL Renegotiation) 

В услуги по проведению НТ также входила необходимость оценить корректность настройки используемых систем защиты от DDoS-атак и возможностей по их обходу, в частности:
+ TCP SYN Flood
+ TCP SYN-ACK Flood
+ TCP ACK Flood
+ TCP RST Flood
+ UDP Flood
+ NTP Flood
+ DNS Flood
+ Fake Session Attack
+ IP Frag Attack
+ PSH-ACK Attack
+ SIP Invite Flood
+ ICMP Flood
+ HTTP Flood (POST/GET)
+ HTTPS Flood (POST/GET)
+ HTTP Slow attack

Много воды лить не буду, все методы реализации, обозначения каждой атаки, какой мониторинг и средства автоматизации использованы описаны на [**Github**](https://github.com/Fireng/Load-Stress-DDoS-Test/tree/main)

### Тестовые сценарии
После нескольких встреч создалась первая картина проведения нагрузочного тестирования, у нас есть Веб-сервис, защита от DDoS-атак, мониторинг (Со стороны Заказчика)
С нашей стороны необходимо разработать: 
+ Модель и профиль нагрузки 
+ Скрипты эмуляции нагрузки 
+ Мониторинг инструмента нагрузочного тестирования Jmeter 
+ Мониторинг всех сценариев DDoS-атак

В процессе Заказчик обеспечил следующие показатели своей инфраструктуры:  
+ Потребление ресурсов центрального процессора, % 
+ Потребление оперативной памяти, МБ 
+ Количество открытых соединений 
+ Занятая полоса пропускания канала (входная и выходная), бит/c

Мы понимали, что есть множество инструментов для разработки сценариев связанных с DDoS-атаками, но нам необходимо было свестись к минимуму, поэтому все скрипты запускаются либо реализованы через Jmeter, из-за его доступности на наших проектах. На этой основе мы начали подготавливать DoS-скрипты.

Например, с плагином UDP Protocol Support скачанного из [Plugins Manager](https://jmeter-plugins.org/wiki/PluginsManager/) удастся реализовать три вида атак, UDP Flood, NTP Flood и DNS Flood. TCP Porotocol Support поможет с TCP SYN Flood, TCP ACK Flood, TCP SYN-ACK Flood, TCP RST Flood. ICMP Flood через OS Process Sampler, который запусукает команду ping с нужными параметрами.

### Мониторинг
Одной из самых сложных вещей остается мониторинг. Просто взять [Wireshark](https://www.wireshark.org/) и перенести его в prometheus/grafana не получится. 

Было рассмотрено множество вариантов, [Suricata](https://suricata.io/),  [Moloch](https://github.com/martinpaljak/moloch), [Zeek](https://zeek.org). [Tcpdump](https://www.tcpdump.org) очень интересный анализатор пакетов командной строки, но для того, чтобы визуализировать данные необходимо самописное средство или стороннее по, которые найдены не были. Нам нужен был быстроразворачиваемый, интуитивно понятный инструмент и им оказался [ntopng](https://www.ntop.org/guides/ntopng/) - это датчик сетевого трафика, который обеспечивает 360-градусный обзор сети, благодаря своей способности собирать информацию о трафике с зеркал трафика, экспортеров NetFlow, SNMP-устройств, журналов брандмауэра, систем обнаружения вторжений.

ntopng был написан в переносимом виде, чтобы его можно было запускать практически на всех платформах Unix, включая Linux и FreeBSD, macOS и Windows. ntopng перехватывает трафик с портов SPAN/mirror или устройств TAP, используя libpcap или PF_RING (в Linux) для достижения наилучшей производительности. Или вы можете использовать его в сочетании с probe для сбора данных о сетевом потоке/sFlow с маршрутизаторов и коммутаторов, или с nProbe Cento для анализа каналов со скоростью 100 Гбит/с на полной скорости.

### Автоматизация
